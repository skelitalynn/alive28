<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Alive28 - 前端纯模拟 Demo</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Ethers v6 (for keccak256) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.4/dist/ethers.umd.min.js"></script>

  <!-- ECharts -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.1/dist/echarts.min.js"></script>

  <style>
    html, body { background: #fff; }
  </style>
</head>
<body class="min-h-screen text-slate-900">
  <div class="max-w-5xl mx-auto px-4 py-6">
    <!-- Top bar -->
    <div class="flex items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-2xl bg-slate-900 text-white grid place-items-center font-bold">A</div>
        <div>
          <div class="text-lg font-semibold leading-tight">Alive28 · 纯前端模拟</div>
          <div class="text-sm text-slate-500">无后端 / LocalStorage 记录 / keccak256 proofHash</div>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <button id="btnHome" class="px-3 py-2 rounded-xl border border-slate-200 hover:bg-slate-50 text-sm">首页</button>
        <button id="btnProgress" class="px-3 py-2 rounded-xl border border-slate-200 hover:bg-slate-50 text-sm">进度</button>
        <button id="btnReportWeek" class="px-3 py-2 rounded-xl border border-slate-200 hover:bg-slate-50 text-sm">周报</button>
        <button id="btnReportFinal" class="px-3 py-2 rounded-xl border border-slate-200 hover:bg-slate-50 text-sm">结营报告</button>
      </div>
    </div>

    <!-- Address bar -->
    <div class="mt-5 rounded-2xl border border-slate-200 p-4">
      <div class="flex flex-col md:flex-row md:items-center gap-3">
        <div class="flex-1">
          <div class="text-sm text-slate-500">当前地址（模拟钱包）</div>
          <div class="mt-1 font-mono text-sm break-all" id="addrDisplay">未连接</div>
        </div>
        <div class="flex flex-col sm:flex-row gap-2">
          <input id="addrInput" class="px-3 py-2 rounded-xl border border-slate-200 w-full sm:w-80 font-mono text-sm"
                 placeholder="输入 0x... 或点随机生成" />
          <button id="btnSetAddr" class="px-3 py-2 rounded-xl bg-slate-900 text-white text-sm hover:bg-slate-800">设为当前</button>
          <button id="btnRandAddr" class="px-3 py-2 rounded-xl border border-slate-200 text-sm hover:bg-slate-50">随机地址</button>
          <button id="btnReset" class="px-3 py-2 rounded-xl border border-rose-200 text-rose-600 text-sm hover:bg-rose-50">清空数据</button>
        </div>
      </div>
      <div class="mt-3 text-xs text-slate-500">
        说明：这是前端纯模拟版本。链上 submitProof/mintDay/composeFinal 这里不发真实交易，只是模拟“确认”并记录 txHash。
        （你之后接入 wagmi/viem 时，把确认按钮替换成真实交易即可）
      </div>
    </div>

    <!-- Main content -->
    <div id="view" class="mt-6"></div>

    <!-- Footer -->
    <div class="mt-10 text-xs text-slate-400">
      数据存储：LocalStorage key = <span class="font-mono">alive28:v1</span> · ProofHash 公式：
      <span class="font-mono">keccak256(utf8(dateKey + "|" + normalizedText + "|" + saltHex))</span>
    </div>
  </div>

<script>
/**
 * Alive28 Mock Demo
 * - SPA routing via location.hash: #/ , #/daily/1 , #/progress , #/report/week , #/report/final
 * - LocalStorage persistence
 * - Deterministic-ish "Reflection" (template-based, less AI-ish)
 * - keccak256 using ethers
 */

const LS_KEY = "alive28:v1";
const CHALLENGE_ID = 1;

const tasks = Array.from({length: 28}, (_, i) => {
  const d = i + 1;
  // Minimal sample tasks; replace with your real tasks.json later.
  const titlePool = [
    "我一定能活下来", "感恩自己", "夸夸自己", "给明天留一点希望",
    "把今天过小一点", "接纳情绪", "重新选择一个边界"
  ];
  const title = titlePool[(d-1) % titlePool.length] + ` · Day ${d}`;
  const instruction = d === 1
    ? "写一句：我会活下来。"
    : d === 6
      ? "记录今天最强烈的情绪，不评判。"
      : "写下今天最想保住的一件事。";
  const hint = d === 6 ? "写“我感到___，因为___”。" : "越短越好。";
  return { dayIndex: d, title, instruction, hint };
});

function loadStore() {
  try {
    const raw = localStorage.getItem(LS_KEY);
    if (!raw) return { users: {}, logs: [] };
    const data = JSON.parse(raw);
    if (!data.users) data.users = {};
    if (!Array.isArray(data.logs)) data.logs = [];
    return data;
  } catch {
    return { users: {}, logs: [] };
  }
}
function saveStore(store) {
  localStorage.setItem(LS_KEY, JSON.stringify(store));
}

function todayDateKey(timezone = Intl.DateTimeFormat().resolvedOptions().timeZone) {
  // Use local timezone only; keep simple.
  const now = new Date();
  const yyyy = now.getFullYear();
  const mm = String(now.getMonth()+1).padStart(2,"0");
  const dd = String(now.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}

function normalizeText(s) {
  return (s || "").trim().replace(/\s+/g, " ").slice(0, 280);
}

function randomHex(bytes) {
  const arr = new Uint8Array(bytes);
  crypto.getRandomValues(arr);
  return "0x" + Array.from(arr).map(b => b.toString(16).padStart(2,"0")).join("");
}

function uuid() {
  const a = crypto.getRandomValues(new Uint8Array(16));
  a[6] = (a[6] & 0x0f) | 0x40;
  a[8] = (a[8] & 0x3f) | 0x80;
  const hex = [...a].map(b=>b.toString(16).padStart(2,"0")).join("");
  return `${hex.slice(0,8)}-${hex.slice(8,12)}-${hex.slice(12,16)}-${hex.slice(16,20)}-${hex.slice(20)}`;
}

function keccakProofHash(dateKey, normalizedText, saltHex) {
  const joined = `${dateKey}|${normalizedText}|${saltHex}`;
  const bytes = ethers.toUtf8Bytes(joined);
  return ethers.keccak256(bytes);
}

function reflectionTemplate(task, normalizedText) {
  const t = normalizedText || "";
  const mood = (() => {
    const map = [
      ["累", "有点累也正常。"],
      ["烦", "今天确实挺烦的。"],
      ["焦虑", "焦虑出现很常见。"],
      ["害怕", "害怕的时候更需要抓住可控的点。"],
      ["开心", "能开心一下很珍贵。"],
      ["难过", "难过不丢人。"],
    ];
    for (const [k, v] of map) if (t.includes(k)) return v;
    return "今天你把这件事写出来了。";
  })();

  const note = (t.length < 8)
    ? `${mood}就先从一句开始也可以。`
    : `${mood}你在做的是把一天重新收回来。`;

  const next = (() => {
    if (task.dayIndex === 6) return "用1分钟补全：我感到__，因为__。";
    if (t.includes("拖") || t.includes("没做")) return "现在定个2分钟计时，只做最小一步。";
    if (t.includes("想") && t.length > 20) return "划掉一句多余的话，只留最关键的一句。";
    return "写一句：我现在最在意的是__。";
  })();

  return { note: note.slice(0,50), next: next.slice(0,30) };
}

function getUser(store, address) {
  const key = address.toLowerCase();
  if (!store.users[key]) {
    store.users[key] = {
      timezone: Intl.DateTimeFormat().resolvedOptions().timeZone || "Asia/Shanghai",
      startDateKey: null,
      streak: 0,
      lastDateKey: null,
      dayMintCount: 0,
      finalMinted: false,
      finalSbtTxHash: null,
    };
    saveStore(store);
  }
  return store.users[key];
}

function findLog(store, address, dateKey) {
  const a = address.toLowerCase();
  return store.logs.find(l => l.address === a && l.challengeId === CHALLENGE_ID && l.dateKey === dateKey) || null;
}

function computeDayIndex(user, dateKey) {
  // Writes startDateKey if empty (used during real checkin)
  if (!user.startDateKey) {
    user.startDateKey = dateKey;
    return 1;
  }
  const [sy, sm, sd] = user.startDateKey.split("-").map(Number);
  const [ty, tm, td] = dateKey.split("-").map(Number);
  const s = new Date(sy, sm-1, sd);
  const t = new Date(ty, tm-1, td);
  const diff = Math.floor((t - s) / (24*3600*1000));
  return diff + 1;
}

function peekDayIndex(user, dateKey) {
  // Read-only: do NOT write startDateKey (used for home button label)
  if (!user.startDateKey) return 1;
  const [sy, sm, sd] = user.startDateKey.split("-").map(Number);
  const [ty, tm, td] = dateKey.split("-").map(Number);
  const s = new Date(sy, sm - 1, sd);
  const t = new Date(ty, tm - 1, td);
  const diff = Math.floor((t - s) / (24 * 3600 * 1000));
  return diff + 1;
}

function updateStreak(user, dateKey) {
  if (!user.lastDateKey) {
    user.streak = 1;
    user.lastDateKey = dateKey;
    return;
  }
  if (user.lastDateKey === dateKey) return;

  const [ly,lm,ld] = user.lastDateKey.split("-").map(Number);
  const last = new Date(ly, lm-1, ld);
  const next = new Date(last.getTime() + 24*3600*1000);
  const nk = `${next.getFullYear()}-${String(next.getMonth()+1).padStart(2,"0")}-${String(next.getDate()).padStart(2,"0")}`;

  if (nk === dateKey) user.streak += 1;
  else user.streak = 1;

  user.lastDateKey = dateKey;
}

function ensureAddr() {
  const addr = window.__alive_addr || "";
  if (!addr || !addr.startsWith("0x") || addr.length < 10) return null;
  return addr.toLowerCase();
}

function navTo(hash) {
  location.hash = hash;
}

function el(html) {
  const t = document.createElement("template");
  t.innerHTML = html.trim();
  return t.content.firstElementChild;
}

function render() {
  const view = document.getElementById("view");
  view.innerHTML = "";
  const hash = location.hash || "#/";
  const addr = ensureAddr();

  if (hash === "#/" || hash === "") {
    view.appendChild(renderHome(addr));
    return;
  }

  if (!addr) {
    view.appendChild(renderNeedAddr());
    return;
  }

  const parts = hash.replace("#","").split("/").filter(Boolean);
  if (parts[0] === "daily") {
    const dayIndex = Number(parts[1] || "1");
    view.appendChild(renderDaily(addr, dayIndex));
    return;
  }
  if (parts[0] === "progress") {
    view.appendChild(renderProgress(addr));
    return;
  }
  if (parts[0] === "report") {
    const range = parts[1] || "week";
    view.appendChild(renderReport(addr, range));
    return;
  }

  view.appendChild(renderHome(addr));
}

function renderNeedAddr() {
  return el(`
    <div class="rounded-2xl border border-slate-200 p-6">
      <div class="text-lg font-semibold">先设置一个地址</div>
      <div class="mt-2 text-slate-500 text-sm">这是纯前端模拟：需要一个 address 来写入 LocalStorage 进度。</div>
      <div class="mt-4 flex gap-2">
        <button class="px-3 py-2 rounded-xl bg-slate-900 text-white text-sm" onclick="document.getElementById('addrInput').focus()">去上面输入地址</button>
        <button class="px-3 py-2 rounded-xl border border-slate-200 text-sm" onclick="document.getElementById('btnRandAddr').click()">随机生成</button>
      </div>
    </div>
  `);
}

function renderHome(addr) {
  // Home button label: show today's DayN if startDateKey exists (read-only)
  let dayBtnLabel = "Day 1";
  let dayBtnTarget = 1;
  if (addr) {
    const store = loadStore();
    const user = getUser(store, addr);
    const dk = todayDateKey(user.timezone);
    const di = peekDayIndex(user, dk);
    dayBtnTarget = Math.min(28, Math.max(1, di));
    dayBtnLabel = `Day ${dayBtnTarget}`;
  }

  return el(`
    <div class="grid md:grid-cols-2 gap-4">
      <div class="rounded-2xl border border-slate-200 p-6">
        <div class="text-xl font-semibold">你要看到的效果</div>
        <div class="mt-2 text-sm text-slate-600 leading-relaxed">
          这是 Alive28 的“可点可跑”前端 Demo：<br/>
          - 每日任务卡（Day 1..28）<br/>
          - 输入一句话 → 生成 note/next<br/>
          - 生成 proofHash（keccak256）<br/>
          - 模拟 submitProof / mintDay / composeFinal（记录 txHash）<br/>
          - 进度页/报告页（ECharts）
        </div>

        <div class="mt-5 flex flex-wrap gap-2">
          <button class="px-3 py-2 rounded-xl bg-slate-900 text-white text-sm hover:bg-slate-800" onclick="location.hash='#/daily/${dayBtnTarget}'">${dayBtnLabel}</button>
          <button class="px-3 py-2 rounded-xl border border-slate-200 text-sm hover:bg-slate-50" onclick="location.hash='#/progress'">进度页</button>
          <button class="px-3 py-2 rounded-xl border border-slate-200 text-sm hover:bg-slate-50" onclick="location.hash='#/report/week'">周报</button>
        </div>

        <div class="mt-6 text-xs text-slate-500">
          当前模式：mock（LocalStorage）。之后接你后端：把 mockClient 换成 httpClient 即可。
        </div>
      </div>

      <div class="rounded-2xl border border-slate-200 p-6">
        <div class="text-xl font-semibold">快速提示</div>
        <div class="mt-2 text-sm text-slate-600 leading-relaxed">
          1) 上面先设置一个 address（随便填一个 0x...）<br/>
          2) 去 Daily 页做一次打卡<br/>
          3) 点“模拟提交 Proof”→ 记录 txHash<br/>
          4) 点“模拟 Mint Day SBT”→ dayMintCount +1<br/>
          5) 进度页会显示 shouldComposeFinal 条件（这里你得把 1..28 都打卡才能合成）
        </div>

        <div class="mt-5 rounded-xl bg-slate-50 p-4">
          <div class="text-sm font-semibold">当前地址</div>
          <div class="mt-1 font-mono text-sm break-all">${addr ? addr : "未连接"}</div>
          <div class="mt-3 text-xs text-slate-500">
            这只是模拟；真实版本用 wagmi/viem 连接钱包并发交易。
          </div>
        </div>
      </div>
    </div>
  `);
}

function renderDaily(address, dayIndex) {
  const store = loadStore();
  const user = getUser(store, address);
  const dateKey = todayDateKey(user.timezone);

  const computedDayIndex = dayIndex; // Demo: trust route param
  const task = tasks.find(t => t.dayIndex === computedDayIndex) || tasks[0];

  const existing = findLog(store, address, dateKey);
  const already = !!existing;
  const log = existing || null;

  const wrap = el(`
    <div class="grid lg:grid-cols-3 gap-4">
      <div class="lg:col-span-2 rounded-2xl border border-slate-200 p-6">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-sm text-slate-500">今日任务</div>
            <div class="mt-1 text-xl font-semibold">${task.title}</div>
            <div class="mt-3 text-sm text-slate-700">指令：${task.instruction}</div>
            <div class="mt-1 text-sm text-slate-500">提示：${task.hint || "—"}</div>
          </div>
          <div class="text-right">
            <div class="text-sm text-slate-500">DayIndex</div>
            <div class="mt-1 font-mono text-lg">${computedDayIndex}</div>
            <div class="mt-2 text-sm text-slate-500">dateKey</div>
            <div class="mt-1 font-mono text-sm">${dateKey}</div>
          </div>
        </div>

        <div class="mt-6">
          <div class="text-sm font-semibold">打卡输入</div>
          <textarea id="dailyText" class="mt-2 w-full min-h-[110px] px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-200 text-sm"
            placeholder="写一句话就行（≤280字）"></textarea>

          <div class="mt-3 flex flex-wrap gap-2">
            <button id="btnCheckin" class="px-3 py-2 rounded-xl bg-slate-900 text-white text-sm hover:bg-slate-800">生成反馈 + ProofHash（模拟 /checkin）</button>
            <button id="btnSubmitProof" class="px-3 py-2 rounded-xl border border-slate-200 text-sm hover:bg-slate-50" disabled>模拟提交 Proof（记录 txHash）</button>
            <button id="btnMintDay" class="px-3 py-2 rounded-xl border border-slate-200 text-sm hover:bg-slate-50" disabled>模拟 Mint Day SBT（记录 txHash）</button>
          </div>

          <div class="mt-3 text-xs text-slate-500">
            幂等：同一天重复 checkin 只会返回第一次的 log（firstWins）。想重新体验请点上方“清空数据”。
          </div>
        </div>

        <div id="dailyOut" class="mt-6 hidden"></div>
      </div>

      <div class="rounded-2xl border border-slate-200 p-6">
        <div class="text-sm text-slate-500">本日状态</div>
        <div class="mt-2">
          <div class="text-sm">今日是否已打卡：<span class="font-semibold" id="todayChecked">${already ? "是（firstWins）" : "否"}</span></div>
          <div class="mt-2 text-sm">Proof 提交状态：<span class="font-semibold" id="proofStatus">${log?.status || "—"}</span></div>
          <div class="mt-2 text-sm">Proof txHash：<div class="mt-1 font-mono text-xs break-all" id="proofTx">${log?.txHash || "—"}</div></div>
          <div class="mt-3 text-sm">DaySBT txHash：<div class="mt-1 font-mono text-xs break-all" id="daySbtTx">${log?.daySbtTxHash || "—"}</div></div>
        </div>

        <div class="mt-6 border-t border-slate-200 pt-5">
          <div class="text-sm text-slate-500">快速跳转</div>
          <div class="mt-3 flex flex-wrap gap-2">
            <button class="px-3 py-2 rounded-xl border border-slate-200 text-sm hover:bg-slate-50" onclick="location.hash='#/daily/${Math.max(1, computedDayIndex-1)}'">上一天</button>
            <button class="px-3 py-2 rounded-xl border border-slate-200 text-sm hover:bg-slate-50" onclick="location.hash='#/daily/${Math.min(28, computedDayIndex+1)}'">下一天</button>
            <button class="px-3 py-2 rounded-xl border border-slate-200 text-sm hover:bg-slate-50" onclick="location.hash='#/progress'">进度</button>
          </div>
        </div>
      </div>
    </div>
  `);

  const textarea = wrap.querySelector("#dailyText");
  const btnCheckin = wrap.querySelector("#btnCheckin");
  const btnSubmitProof = wrap.querySelector("#btnSubmitProof");
  const btnMintDay = wrap.querySelector("#btnMintDay");
  const out = wrap.querySelector("#dailyOut");

  if (already && log?.normalizedText) textarea.value = log.normalizedText;

  function refreshSide() {
    const store2 = loadStore();
    const u2 = getUser(store2, address);
    const dk = todayDateKey(u2.timezone);
    const lg = findLog(store2, address, dk);
    wrap.querySelector("#todayChecked").textContent = lg ? "是（firstWins）" : "否";
    wrap.querySelector("#proofStatus").textContent = lg?.status || "—";
    wrap.querySelector("#proofTx").textContent = lg?.txHash || "—";
    wrap.querySelector("#daySbtTx").textContent = lg?.daySbtTxHash || "—";
  }

  function showOutput(logObj, alreadyCheckedIn) {
    out.classList.remove("hidden");
    out.innerHTML = `
      <div class="rounded-2xl bg-slate-50 p-5 border border-slate-200">
        <div class="flex items-center justify-between gap-3">
          <div class="text-sm font-semibold">/checkin 输出（模拟）</div>
          <div class="text-xs text-slate-500">${alreadyCheckedIn ? "alreadyCheckedIn=true（幂等返回）" : "alreadyCheckedIn=false"}</div>
        </div>

        <div class="mt-3 grid md:grid-cols-2 gap-4">
          <div>
            <div class="text-xs text-slate-500">reflection</div>
            <div class="mt-1 text-sm"><span class="font-semibold">note：</span>${logObj.reflection.note}</div>
            <div class="mt-1 text-sm"><span class="font-semibold">next：</span>${logObj.reflection.next}</div>
          </div>
          <div>
            <div class="text-xs text-slate-500">proof inputs</div>
            <div class="mt-1 text-xs font-mono break-all">saltHex: ${logObj.saltHex}</div>
            <div class="mt-1 text-xs font-mono break-all">proofHash: ${logObj.proofHash}</div>
          </div>
        </div>

        <div class="mt-4 text-xs text-slate-500">
          下一步：点“模拟提交 Proof”→ 记录 txHash → 再点“模拟 Mint Day SBT”。
        </div>
      </div>
    `;

    btnSubmitProof.disabled = false;
    btnMintDay.disabled = false;
  }

  btnCheckin.addEventListener("click", () => {
    const store = loadStore();
    const user = getUser(store, address);
    const dateKey = todayDateKey(user.timezone);

    const exist = findLog(store, address, dateKey);
    if (exist) {
      showOutput(exist, true);
      refreshSide();
      return;
    }

    // Initialize startDateKey + compute (real logic uses computed; demo uses route dayIndex)
    computeDayIndex(user, dateKey);
    const di = computedDayIndex;

    const raw = textarea.value;
    const normalizedText = normalizeText(raw);

    const saltHex = randomHex(16);
    const proofHash = keccakProofHash(dateKey, normalizedText, saltHex);

    const reflection = reflectionTemplate({dayIndex: di, ...task}, normalizedText);

    updateStreak(user, dateKey);

    const logObj = {
      id: uuid(),
      address: address.toLowerCase(),
      challengeId: CHALLENGE_ID,
      dayIndex: di,
      dateKey,
      normalizedText,
      reflection,
      saltHex,
      proofHash,
      status: "CREATED",
      txHash: null,
      daySbtTxHash: null,
      createdAt: new Date().toISOString()
    };

    store.logs.push(logObj);
    store.users[address.toLowerCase()] = user;
    saveStore(store);

    showOutput(logObj, false);
    refreshSide();
  });

  btnSubmitProof.addEventListener("click", () => {
    const store = loadStore();
    const user = getUser(store, address);
    const dateKey = todayDateKey(user.timezone);
    const log = findLog(store, address, dateKey);
    if (!log) return alert("请先 checkin 生成 proofHash");

    if (log.txHash) return alert("已提交过 Proof（幂等）");

    log.txHash = ethers.keccak256(ethers.toUtf8Bytes("tx:proof:" + log.proofHash + ":" + Date.now()));
    log.status = "SUBMITTED";
    saveStore(store);

    refreshSide();
    alert("已模拟提交 Proof（已记录 txHash）");
  });

  btnMintDay.addEventListener("click", () => {
    const store = loadStore();
    const user = getUser(store, address);
    const dateKey = todayDateKey(user.timezone);
    const log = findLog(store, address, dateKey);
    if (!log) return alert("请先 checkin");
    if (!log.txHash) return alert("请先模拟提交 Proof（submitProof）");
    if (log.daySbtTxHash) return alert("今日 DaySBT 已 mint（幂等）");

    log.daySbtTxHash = ethers.keccak256(ethers.toUtf8Bytes("tx:sbt:day:" + log.dayIndex + ":" + Date.now()));
    user.dayMintCount = Math.min(28, (user.dayMintCount || 0) + 1);

    store.users[address.toLowerCase()] = user;
    saveStore(store);

    refreshSide();
    alert("已模拟 Mint DaySBT（已记录 txHash）");
  });

  if (already) {
    btnSubmitProof.disabled = false;
    btnMintDay.disabled = false;
    if (log) showOutput(log, true);
  }

  return wrap;
}

function renderProgress(address) {
  const store = loadStore();
  const user = getUser(store, address);
  const dateKey = todayDateKey(user.timezone);

  const todayLog = findLog(store, address, dateKey);
  const todayCheckedIn = !!todayLog;

  const completedDays = store.logs
    .filter(l => l.address === address.toLowerCase() && l.challengeId === CHALLENGE_ID)
    .map(l => l.dayIndex)
    .sort((a,b)=>a-b);

  const shouldMintDay = todayCheckedIn && !todayLog?.daySbtTxHash;
  const mintableDayIndex = todayLog?.dayIndex || null;

  const shouldComposeFinal = (user.dayMintCount === 28) && !user.finalMinted;

  const wrap = el(`
    <div class="grid lg:grid-cols-3 gap-4">
      <div class="lg:col-span-2 rounded-2xl border border-slate-200 p-6">
        <div class="flex items-start justify-between">
          <div>
            <div class="text-sm text-slate-500">进度</div>
            <div class="mt-1 text-xl font-semibold">你的挑战状态</div>
          </div>
          <div class="text-right">
            <div class="text-sm text-slate-500">dateKey</div>
            <div class="mt-1 font-mono text-sm">${dateKey}</div>
          </div>
        </div>

        <div class="mt-5 grid sm:grid-cols-2 gap-4">
          <div class="rounded-2xl bg-slate-50 border border-slate-200 p-5">
            <div class="text-xs text-slate-500">streak</div>
            <div class="mt-1 text-3xl font-semibold">${user.streak || 0}</div>
            <div class="mt-2 text-sm text-slate-600">连续完成天数（模拟规则）</div>
          </div>

          <div class="rounded-2xl bg-slate-50 border border-slate-200 p-5">
            <div class="text-xs text-slate-500">DaySBT 已铸造</div>
            <div class="mt-1 text-3xl font-semibold">${user.dayMintCount || 0}<span class="text-base font-normal text-slate-400">/28</span></div>
            <div class="mt-2 text-sm text-slate-600">每日一枚（模拟 /sbt/confirm）</div>
          </div>
        </div>

        <div class="mt-4 rounded-2xl border border-slate-200 p-5">
          <div class="text-sm font-semibold">按钮状态</div>
          <div class="mt-2 text-sm text-slate-700">
            shouldMintDay：<span class="font-semibold">${shouldMintDay ? "true" : "false"}</span>
            ${shouldMintDay && mintableDayIndex ? `<span class="text-slate-500">（可 mint Day ${mintableDayIndex}）</span>` : ""}
          </div>
          <div class="mt-1 text-sm text-slate-700">
            shouldComposeFinal：<span class="font-semibold">${shouldComposeFinal ? "true" : "false"}</span>
          </div>

          <div class="mt-4 flex flex-wrap gap-2">
            <button id="btnGoToday" class="px-3 py-2 rounded-xl border border-slate-200 text-sm hover:bg-slate-50">去今日</button>
            <button id="btnComposeFinal" class="px-3 py-2 rounded-xl bg-slate-900 text-white text-sm hover:bg-slate-800" ${shouldComposeFinal ? "" : "disabled"}>${shouldComposeFinal ? "模拟合成 FinalSBT" : "未满足合成条件"}</button>
          </div>

          <div class="mt-3 text-xs text-slate-500">
            合成条件：dayMintCount == 28 且 finalMinted == false（这里不查链）。
          </div>
        </div>

        <div class="mt-4 rounded-2xl border border-slate-200 p-5">
          <div class="text-sm font-semibold">完成的 DayIndex</div>
          <div class="mt-3 flex flex-wrap gap-2">
            ${completedDays.length ? completedDays.map(d => `<button class="px-2.5 py-1.5 rounded-xl border border-slate-200 text-sm hover:bg-slate-50" onclick="location.hash='#/daily/${d}'">Day ${d}</button>`).join("") : `<div class="text-sm text-slate-500">暂无记录</div>`}
          </div>
        </div>
      </div>

      <div class="rounded-2xl border border-slate-200 p-6">
        <div class="text-sm text-slate-500">FinalSBT</div>
        <div class="mt-2 text-lg font-semibold">${user.finalMinted ? "已合成" : "未合成"}</div>
        <div class="mt-3 text-sm text-slate-700">finalMinted：<span class="font-semibold">${user.finalMinted ? "true" : "false"}</span></div>
        <div class="mt-3 text-sm text-slate-700">final txHash：</div>
        <div class="mt-1 font-mono text-xs break-all">${user.finalSbtTxHash || "—"}</div>

        <div class="mt-6 border-t border-slate-200 pt-5">
          <div class="text-sm text-slate-500">报告</div>
          <div class="mt-3 flex flex-wrap gap-2">
            <button class="px-3 py-2 rounded-xl border border-slate-200 text-sm hover:bg-slate-50" onclick="location.hash='#/report/week'">周报</button>
            <button class="px-3 py-2 rounded-xl border border-slate-200 text-sm hover:bg-slate-50" onclick="location.hash='#/report/final'">结营</button>
          </div>
        </div>
      </div>
    </div>
  `);

  wrap.querySelector("#btnGoToday").addEventListener("click", () => {
    const store2 = loadStore();
    const u2 = getUser(store2, address);
    const dk = todayDateKey(u2.timezone);
    const lg = findLog(store2, address, dk);
    location.hash = `#/daily/${lg?.dayIndex || 1}`;
  });

  wrap.querySelector("#btnComposeFinal").addEventListener("click", () => {
    const store2 = loadStore();
    const u2 = getUser(store2, address);

    if (u2.finalMinted) return alert("已合成（幂等）");
    if (u2.dayMintCount !== 28) return alert("dayMintCount 未到 28");

    const logs = store2.logs.filter(l => l.address === address.toLowerCase() && l.challengeId === CHALLENGE_ID);
    const mintedDays = new Set(logs.filter(l=>l.daySbtTxHash).map(l=>l.dayIndex));
    for (let i=1;i<=28;i++) if (!mintedDays.has(i)) return alert(`缺少 Day ${i} 的 DaySBT mint 记录`);

    u2.finalMinted = true;
    u2.finalSbtTxHash = ethers.keccak256(ethers.toUtf8Bytes("tx:sbt:final:" + Date.now()));
    store2.users[address.toLowerCase()] = u2;
    saveStore(store2);
    alert("已模拟合成 FinalSBT");
    render();
  });

  return wrap;
}

function renderReport(address, range) {
  const store = loadStore();
  const logs = store.logs
    .filter(l => l.address === address.toLowerCase() && l.challengeId === CHALLENGE_ID)
    .sort((a,b)=>a.dateKey.localeCompare(b.dateKey));

  const title = range === "final" ? "结营报告（模拟）" : "周报（模拟）";
  const wrap = el(`
    <div class="rounded-2xl border border-slate-200 p-6">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="text-sm text-slate-500">报告</div>
          <div class="mt-1 text-xl font-semibold">${title}</div>
        </div>
        <div class="flex gap-2">
          <button class="px-3 py-2 rounded-xl border border-slate-200 text-sm hover:bg-slate-50" onclick="location.hash='#/report/week'">周报</button>
          <button class="px-3 py-2 rounded-xl border border-slate-200 text-sm hover:bg-slate-50" onclick="location.hash='#/report/final'">结营</button>
        </div>
      </div>

      <div class="mt-5 grid lg:grid-cols-2 gap-4">
        <div class="rounded-2xl bg-slate-50 border border-slate-200 p-5">
          <div class="text-sm font-semibold">reportText</div>
          <div id="reportText" class="mt-3 text-sm text-slate-700 leading-relaxed"></div>
        </div>

        <div class="rounded-2xl bg-slate-50 border border-slate-200 p-5">
          <div class="text-sm font-semibold">chartData（打卡次数）</div>
          <div id="chart" class="mt-3" style="width:100%;height:260px;"></div>
        </div>
      </div>

      <div class="mt-5 rounded-2xl border border-slate-200 p-5">
        <div class="text-sm font-semibold">最近 6 条日志（reflection）</div>
        <div id="logList" class="mt-3 space-y-3"></div>
      </div>
    </div>
  `);

  const recent = logs.slice(-6).reverse();

  const total = logs.length;
  const minted = logs.filter(l=>l.daySbtTxHash).length;
  const streak = (loadStore().users[address.toLowerCase()]?.streak) || 0;
  const text = (() => {
    if (!total) return "你还没有打卡记录。先去 Daily 页写一句话。";
    if (range === "final") {
      return `你累计记录了 ${total} 天，已模拟铸造 ${minted} 枚 DaySBT，当前 streak 为 ${streak}。结营版本建议：挑一条你最想保留的“边界”，把它写成一句固定句，接下来每周读一遍。`;
    }
    return `这段时间你记录了 ${total} 天，已模拟铸造 ${minted} 枚 DaySBT。你的节奏更像“先做一小步再往下走”。如果要继续：每天只保留一句最关键的句子。`;
  })();

  wrap.querySelector("#reportText").textContent = text;

  const list = wrap.querySelector("#logList");
  for (const l of recent) {
    list.appendChild(el(`
      <div class="rounded-xl bg-white border border-slate-200 p-4">
        <div class="flex items-center justify-between gap-3">
          <div class="text-sm font-semibold">Day ${l.dayIndex} · ${l.dateKey}</div>
          <div class="text-xs text-slate-500">${l.daySbtTxHash ? "DaySBT✅" : "DaySBT—"} · ${l.txHash ? "Proof✅" : "Proof—"}</div>
        </div>
        <div class="mt-2 text-sm"><span class="text-slate-500">note：</span>${l.reflection.note}</div>
        <div class="mt-1 text-sm"><span class="text-slate-500">next：</span>${l.reflection.next}</div>
      </div>
    `));
  }

  const byDay = new Array(28).fill(0);
  for (const l of logs) {
    if (l.dayIndex >=1 && l.dayIndex<=28) byDay[l.dayIndex-1] += 1;
  }

  const chartDom = wrap.querySelector("#chart");
  const chart = echarts.init(chartDom);
  chart.setOption({
    tooltip: {},
    xAxis: { type: "category", data: byDay.map((_,i)=>String(i+1)) },
    yAxis: { type: "value" },
    series: [{ type: "bar", data: byDay }]
  });

  return wrap;
}

/* Top bar buttons */
document.getElementById("btnHome").addEventListener("click", () => navTo("#/"));
document.getElementById("btnProgress").addEventListener("click", () => navTo("#/progress"));
document.getElementById("btnReportWeek").addEventListener("click", () => navTo("#/report/week"));
document.getElementById("btnReportFinal").addEventListener("click", () => navTo("#/report/final"));

/* Address handling */
function setAddr(addr) {
  window.__alive_addr = addr;
  document.getElementById("addrDisplay").textContent = addr ? addr.toLowerCase() : "未连接";
  render();
}
document.getElementById("btnSetAddr").addEventListener("click", () => {
  const val = document.getElementById("addrInput").value.trim();
  if (!val.startsWith("0x") || val.length < 10) return alert("请输入类似 0x... 的地址（模拟也行）");
  setAddr(val);
});
document.getElementById("btnRandAddr").addEventListener("click", () => {
  const a = randomHex(20);
  document.getElementById("addrInput").value = a;
  setAddr(a);
});
document.getElementById("btnReset").addEventListener("click", () => {
  if (!confirm("确认清空本地数据？")) return;
  localStorage.removeItem(LS_KEY);
  alert("已清空 LocalStorage");
  render();
});

/* Init */
(function init() {
  const last = localStorage.getItem("alive28:last_addr");
  if (last) setAddr(last);
  else setAddr("");

  const origSetAddr = setAddr;
  setAddr = (addr) => {
    if (addr) localStorage.setItem("alive28:last_addr", addr.toLowerCase());
    origSetAddr(addr);
  };

  window.addEventListener("hashchange", render);
  if (!location.hash) location.hash = "#/";
  render();
})();
</script>
</body>
</html>
