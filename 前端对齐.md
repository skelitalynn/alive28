# 前端对齐（frontend 已替换完成）问题清单与建议

目标：frontend 已替换完成（UI 不改），确保逻辑与后端联调规则一致、可稳定运行。

---

## 1) 必须修正（否则联调会出错）

### 1.0 SBT 相关逻辑必须移除（与最新文档冲突）
- 位置：
  - `frontend/src/lib/api/httpClient.ts`
  - `frontend/src/lib/api/mockClient.ts`
  - `frontend/src/app/daily/[dayIndex]/page.tsx`
  - `frontend/src/app/progress/page.tsx`
  - `frontend/src/app/milestone/[id]/page.tsx`
  - `frontend/src/lib/store/schema.ts`
- 现状：
  - 仍在调用 `mintDay / composeFinal / /sbt/confirm`
  - 仍依赖 `dayMintCount / finalMinted / daySbtTxHash / finalSbtTxHash`
- 影响：
  - 后端已按最新文档移除 SBT 相关接口与字段，HTTP 模式会直接 404/报错
- 建议修正：
  - 删除所有 SBT 相关调用与字段
  - 里程碑只保留 `mintMilestone`，最终里程碑用 `milestoneId=3`

### 1.1 mock 逻辑与规则不一致
- 位置：`frontend/src/lib/api/mockClient.ts`
- 现状：按 `startDateKey + dayIndex` 计算 `dateKey`，并要求 `log.dayIndex === dayIndex` 才算已打卡。
- 影响：
  - 破坏「同 address+dateKey 只能有一条 log（firstWins）」的幂等规则
  - `submitProof`/`mintDay` 可能提示“请先 checkin”
  - Daily 页可能加载不到当日日志
- 建议修正：恢复旧逻辑（按 `todayDateKey` 查今日 log；`alreadyCheckedIn` 不依赖 `dayIndex`）。

### 1.2 DailyLog 新增字段未映射
- 位置：`frontend/src/lib/api/httpClient.ts` → `mapLog()`
- 现状：`DailyLog` 新增 `nftImage`，但 `mapLog` 未填充，strict 模式会报错。
- 建议修正：在 `mapLog` 中补上
  - `nftImage: raw.nftImage ?? raw.nft_image ?? null`


### 1.4 后端不需要再兼容 SBT
- 说明：按最新项目文档，后端仅保留里程碑 NFT 逻辑。
- 结论：不要要求后端回补 `/sbt/confirm` 或 SBT 字段，否则会与文档冲突。

---

## 4) 可选修正（不改也能跑，但建议）

### 4.1 WalletConnect 环境变量
- 位置：`frontend/src/lib/wagmi/config.ts`
- 说明：`NEXT_PUBLIC_WALLETCONNECT_PROJECT_ID` 为空时，WalletConnect 可能异常。
- 建议：配置环境变量或移除 WalletConnect connector。

### 4.2 mock 模式会调用后端 /ai/reflection
- 位置：`frontend/src/lib/api/mockClient.ts` → `spoonClient`
- 说明：mock 模式也会调用后端 `/ai/reflection`（经 `NEXT_PUBLIC_API_BASE`）。
- 建议：若只走 HTTP 模式，可以保留；若要 mock 可用，需配好 Key 或改为纯模板。

---

## 5) 替代落地步骤（建议）
1) 先修复第 1 章的 “必须修正”（尤其是 **移除 SBT 逻辑**）
2) 处理第 2 章安全项（至少去掉硬编码 Key）
3) 统一修复乱码编码
4) 目录替换已完成：`frontend` 已是新前端

---

如需我直接改代码、或提供补丁清单，请告诉我。

